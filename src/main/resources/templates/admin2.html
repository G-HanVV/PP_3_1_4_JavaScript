<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Management</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-4">
  <h1 class="text-center">User Management</h1>
  <!-- Вкладки -->
  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab" aria-controls="users" aria-selected="true">
        Users
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="create-user-tab" data-bs-toggle="tab" data-bs-target="#create-user" type="button" role="tab" aria-controls="create-user" aria-selected="false">
        Create User
      </button>
    </li>
  </ul>
  <div class="tab-content mt-3" id="myTabContent">
    <!-- Вкладка с таблицей пользователей -->
    <div class="tab-pane fade show active" id="users" role="tabpanel" aria-labelledby="users-tab">
      <h3>User List</h3>
      <table class="table table-bordered table-striped">
        <thead id="userTableHead"></thead>
        <tbody id="userTableBody"></tbody>
      </table>
    </div>
    <!-- Вкладка с формой создания пользователя -->
    <div class="tab-pane fade" id="create-user" role="tabpanel" aria-labelledby="create-user-tab">
      <h3>Create New User</h3>
      <form id="userForm"></form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_URL = '/api/users';

  // Динамическое построение таблицы и формы на основе данных
  async function buildDynamicUI(users) {
    if (users.length === 0) return; // Если пользователей нет, не создаём таблицу и форму

    const firstUser = users[0]; // Берём первого пользователя для определения структуры
    const keys = Object.keys(firstUser); // Достаём ключи объекта

    // Построение заголовков таблицы
    const tableHead = document.getElementById('userTableHead');
    tableHead.innerHTML = '<tr>' + keys.map(key => `<th>${key}</th>`).join('') + '</tr>';

    // Построение формы
    const form = document.getElementById('userForm');
    form.innerHTML = keys.map(key => {
      if (Array.isArray(firstUser[key])) {
        // Если поле является массивом, создаём динамическую форму для каждого элемента массива
        return `
                    <div class="mb-3">
                        <label class="form-label">${key}</label>
                        <div id="${key}">
                            <button type="button" class="btn btn-secondary" onclick="addAddressField('${key}')">Add Address</button>
                        </div>
                    </div>
                `;
      }
      return `
                <div class="mb-3">
                    <label for="${key}" class="form-label">${key}</label>
                    <input type="text" id="${key}" name="${key}" class="form-control" required>
                </div>
            `;
    }).join('') + `
            <button type="submit" class="btn btn-primary">Create User</button>
        `;

    // Добавляем обработчик отправки формы
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = {};

      keys.forEach(key => {
        if (Array.isArray(firstUser[key])) {
          // Для массивов мы будем собирать объекты
          formData[key] = [];
          document.querySelectorAll(`#${key} input`).forEach(input => {
            formData[key].push(input.value);
          });
        } else {
          formData[key] = document.getElementById(key).value;
        }
      });

      await addUser(formData);
      loadUsers(); // Перезагружаем пользователей
      form.reset(); // Сбрасываем форму
    });
  }

  // Функция для получения списка пользователей и обновления таблицы
  async function loadUsers() {
    const response = await fetch(API_URL);
    const users = await response.json();

    if (users.length > 0) {
      await buildDynamicUI(users); // Строим интерфейс только при наличии данных
    }

    const tableBody = document.getElementById('userTableBody');
    tableBody.innerHTML = ''; // Очищаем таблицу

    users.forEach(user => {
      const row = document.createElement('tr');
      Object.keys(user).forEach(key => {
        if (Array.isArray(user[key])) {
          // Если поле является массивом, отображаем данные как список
          row.innerHTML += `<td>${user[key].map(val => `<div>${JSON.stringify(val)}</div>`).join('')}</td>`;
        } else {
          row.innerHTML += `<td>${user[key]}</td>`;
        }
      });
      tableBody.appendChild(row);
    });
  }

  // Функция для добавления нового пользователя
  async function addUser(user) {
    await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(user)
    });
  }

  // Функция для добавления нового поля для массива (например, для адресов)
  function addAddressField(key) {
    const container = document.getElementById(key);
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'form-control';
    input.placeholder = 'Address';
    container.appendChild(input);
  }

  // Инициализация интерфейса
  async function init() {
    await loadUsers();
  }

  // Запуск приложения
  init();
</script>
</body>
</html>