<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Management</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-4">
  <h1 class="text-center">User Management</h1>
  <!-- Вкладки -->
  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab" aria-controls="users" aria-selected="true">
        Users
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="create-user-tab" data-bs-toggle="tab" data-bs-target="#create-user" type="button" role="tab" aria-controls="create-user" aria-selected="false">
        Create User
      </button>
    </li>
  </ul>
  <div class="tab-content mt-3" id="myTabContent">
    <!-- Вкладка с таблицей пользователей -->
    <div class="tab-pane fade show active" id="users" role="tabpanel" aria-labelledby="users-tab">
      <h3>User List</h3>
      <table class="table table-bordered table-striped">
        <thead id="userTableHead"></thead>
        <tbody id="userTableBody"></tbody>
      </table>
    </div>
    <!-- Вкладка с формой создания пользователя -->
    <div class="tab-pane fade" id="create-user" role="tabpanel" aria-labelledby="create-user-tab">
      <h3>Create New User</h3>
      <form id="userForm"></form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_URL = '/api/users';
  const ROLES_API_URL = '/api/users/roles';

  async function loadUsers() {
    const response = await fetch(API_URL);
    const users = await response.json();
    const tableHead = document.getElementById('userTableHead');
    tableHead.innerHTML = '<tr><th>Name</th><th>Age</th><th>Roles</th></tr>';

    const tableBody = document.getElementById('userTableBody');
    tableBody.innerHTML = '';

    users.forEach(user => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${user.name}</td><td>${user.age}</td><td>${user.roles.map(role => role.authority).join(', ')}</td>`;
      tableBody.appendChild(row);
    });
  }

  async function loadRoles() {
    const response = await fetch(ROLES_API_URL);
    const roles = await response.json();

    const form = document.getElementById('userForm');
    form.innerHTML = `
            <div class="mb-3">
                <label for="name" class="form-label">Name</label>
                <input type="text" id="name" name="name" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="age" class="form-label">Age</label>
                <input type="number" id="age" name="age" class="form-control" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Roles</label>
                <div id="roles-container">
                    ${roles.map(role => `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${role.id}" id="role-${role.id}">
                            <label class="form-check-label" for="role-${role.id}">
                                ${role.authority}
                            </label>
                        </div>
                    `).join('')}
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Create User</button>
        `;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('name').value;
      const age = document.getElementById('age').value;
      const selectedRoles = [];

      roles.forEach(role => {
        if (document.getElementById(`role-${role.id}`).checked) {
          selectedRoles.push(role);
        }
      });

      const user = { name, age, roles: selectedRoles };
      await addUser(user);
      loadUsers(); // Обновляем список пользователей
    });
  }

  async function addUser(user) {
    await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(user)
    });
  }

  async function init() {
    await loadUsers();
    await loadRoles(); // Загружаем доступные роли
  }

  init();
</script>
</body>
</html>